# 第三节 用户行为监控

## No.1 如何精确统计页面停留时长?

* 业务场景: 需要满足单页、多页应用,用户切换Tab、最小化窗口等操作情况,并且不耦合或入侵业务代码.
* 考虑页面生命周期:
  * 进入页面: 首次加载、页面跳转、刷新、浏览器前进后退;
  * 活跃状态切换: 页面失去焦点/获得焦点、切换窗口最小化、切换浏览器tab、电脑睡眠和唤醒;
  * 离开: 关闭窗口、页面跳转、刷新、浏览器前进后退.

* 计算公式: 统计活跃停留时长 = 各个活跃区间段相加; 统计总时长 = 退出时间点 - 入口时间点;

* 监听页面的进入和离开
  * 页面进入: window.onload
  * 页面离开: window.unload
  * 页面前进: pageshow
  * 页面后退: pagehide
  * 单页应用内部跳转: 监听路由变化

* 上报数据的时机:下次打开页面时上报,触发window.onbeforeunload事件的时候把当前页面数据暂存在localStorage中.当用户下次进入页面的时候会把暂存数据上报.

* 上报类设计

  * 需要对原生事件和自定义事件的封装:监听enter、activechange、exit事件来操作当前实例;


