# 第三节 用户行为监控

> 在线上项目中,需要统计产品中用户行为和使用情况,从而可以从用户和产品的角度去了解用户群体,从而升级和迭代产品,使其更加贴近用户.用户行为数据可以通过前端数据监控的方式获得

## 实现前端监控步骤:

前端埋点和上报->数据处理->数据分析.

## 一、为什么需要前端监控?

前端监控的目的是:获取用户行为以及跟踪产品在用户端的使用情况,并以监控数据为基础,指明产品优化的方向.

## 二、数据监控的指标以及意义

数据监控的指标有:

* PV/UV: PV(page view),即页面浏览量或点击量.UV指访问某个站点或点击某条新闻的不同IP地址的人数;
* 用户在每一个页面的停留时间;
* 用户通过什么入口来访问该网页;
* 用户在相应的页面中触发的行为.

意义: 我们能够知道用户来源的渠道,可以促进产品的推广,知道用户在每一个页面停留的时间,可以针对停留较长的页面,增加广告推送等.

## 三、常用前端埋点方案

实现前端监控的步骤为:前端埋点和上报、数据处理和数据分析.首要的步骤就是前端埋点和上报,也就是数据的收集阶段.数据收集的丰富性和准确性会影响对产品线上效果的判别结果.

目前常见的前端埋点方法分为三种:代码埋点、可视化埋点和无痕埋点.

* 代码埋点: 优点,可以在任意时刻,精确的发送或保存所需要的数据信息; 缺点,工作量较大,每一个组件的埋点都需要添加相应的代码.

* 可视化埋点: 优点,可以通过可视化系统将埋点代码嵌入业务代码; 缺点,可视化埋点控件有限,不能手动定制.

* 无埋点:任意一个事件都被绑定一个标识,所有的事件都被记录下来.优点,采集了全量数据,所有产品迭代过程中是不需要关注埋点逻辑,也不会出现漏埋、误埋等现象; 缺点,采集全量数据给数据传输和服务器增加压力,无法灵活定制各个事件所需要上传的数据.

## 四、如何精确统计页面停留时长?

* 业务场景: 需要满足单页、多页应用,用户切换Tab、最小化窗口等操作情况,并且不耦合或入侵业务代码.
* 考虑页面生命周期:
  * 进入页面: 首次加载、页面跳转、刷新、浏览器前进后退;
  * 活跃状态切换: 页面失去焦点/获得焦点、切换窗口最小化、切换浏览器tab、电脑睡眠和唤醒;
  * 离开: 关闭窗口、页面跳转、刷新、浏览器前进后退.

* 计算公式: 统计活跃停留时长 = 各个活跃区间段相加; 统计总时长 = 退出时间点 - 入口时间点;

* 监听页面的进入和离开
  * 页面进入: window.onload
  * 页面离开: window.unload
  * 页面前进: pageshow
  * 页面后退: pagehide
  * 单页应用内部跳转: 监听路由变化

* 上报数据的时机:下次打开页面时上报,触发window.onbeforeunload事件的时候把当前页面数据暂存在localStorage中.当用户下次进入页面的时候会把暂存数据上报.

* 上报类设计

  * 需要对原生事件和自定义事件的封装:监听enter、activechange、exit事件来操作当前实例;


