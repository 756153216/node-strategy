# 第七篇: Node.js建设运营活动体系

> 随着开发团队规模不断发展壮大,在人员增加的同时也带来了协作成本的增加,业务项目越来越多,类型也各不相同,常见的类型有活动类、组件类、基于框架类的业务项目、Node.js直出等,如果想要对每个项目进行一些规范的约束,比如git提交规范、JS代码规范,这些都需要通过工程化来保证,从项目创建、开发、构建、代码规范检查、自动化测试、最终项目上线

## 一. 运营活动遇到的痛点

1. 项目拷贝

  * 容易出错: 某个关键文件拷贝丢失或者错误,耗费大量精力排查问题;
  * 目录结构多变: 运营活动页面组合定制化多,需要各种不同的UI和交互体验;
  * 踩坑的经验难以传承: 活动经常是一次性的,零散且随意性大.

2. 配置的频繁修改, 比如基于React+redux组件化开发方式中,一个页面或者webapp是由多个容器组件拼装后渲染而成.

  * 某个组件通常由模板、cgi数据和事件组成.面临经常要修改文案或者图片等静态数据;

3. 缺少协作规范

  * 没有版本控制与发布平台的流程,维护者很难追溯历史;

4. 缺少代码规范

  * 经常缺少工具强制约束,没有ESLint或JSLint

## 二. 运营活动的核心诉求是什么?

* 模板的定制化与可视化: 定义模板的HTML代码及其关联的数据配置结构;

* 支持热插拔(插件机制): 每个widget包括源码和数据配置两部分,做数据与源码版本分离;

* 需要一个可视化的运营平台: 支持创建页面、预览页面、配置物料; 提测与发布;

* 系统处理: 将可视化的预览页面+物料数据,打包成提测或发布版本;

* 数据打通: 数据来源不仅可以运营自己配,还需要打通从三方平台获取,需要支持http/rpc, 数据落地存储;

* API模板: 面对个性化内容,需要提供一些API模板,检查数据配置中有没有一些特定的字段,调用对应的服务拉取真实的数据内容;

* 故障: 需要有告警和监控平台来快速发现并定位问题

## 三. Node.js运营体系建设

* 现有条件分析:

  * 是否有历史包袱
  * 团队是否有Node.js技术栈的人员梯队

* 为什么选Node

  * 提供用户体验和服务器能力——团队现状需求
  * 人人都会配置前端页面——运营/开发提升效率需要
  * 现有后端人力不足,前端来主导——提升团队间协作的需要
  * 前端同构减少重复劳动力——开发团队需要

* 可实践的工程化

1. 页面配置平台: 

  * 活动链接配置:
  
    * 对一个活动页面,生成url入口,外部服务调用调用该入口;
    * 配置平台设置映射规则: 例如起止时间、地域、渠道,活动的上下线切换等;

  * 活动页面生成:

    * 简单可组合的页面搭建平台,生成活动页面;

  * 静态页面配置:

    * 针对没有接口交互的展示活动页面,产品可以进行图文修改即可直接生成页面.

2. 接口中间层: 客户端对接口访问,先经过Node接口中间层,由中间层代理接口服务

  * 接口聚合: 对于用户状态获取、内容展示需要请求多个接口的页面,可以使用接口聚合,后端只需提供RESTFUL原子接口,聚合由Node层来根据场景开发.

  * 大文件上传: 用户申请验证,如拍照或短视频,在不好的网络条件下,需要分片和断点续传, Node层可以指定接口获取大文件,通过内网交由逻辑层处理,也可以考虑使用WS长连接方式.

3. 服务端直出: 可以很好的同构代码和版本迭代;

4. 其它场景:微服务

  * 图片服务: 在不同的客户端环境返回不同大小/格式的图片; 实现文案+图片素材的动态合图返回给前端

## 四、简化架构图

![node-activity](/assets/node-activity.png)

## 参考

* [营销支撑之路](https://github.com/amfe/article/blob/master/%E8%90%A5%E9%94%80%E6%94%AF%E6%92%91%E4%B9%8B%E8%B7%AF.md)

* [Node.js应用场景](https://github.com/CntChen/cntchen.github.io/issues/7)